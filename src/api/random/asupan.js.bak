const path = require('path');
const fs = require('fs');
const axios = require('axios');

module.exports = function (app) {
    const ASUPAN_JSON_URL = "https://raw.githubusercontent.com/Yuri-Neko/database/refs/heads/main/asupan/asupan.json";
    const CACHE_TIME = 5 * 60 * 1000;
    
    let videoCache = null;
    let cacheTimestamp = 0;

    async function fetchVideoList() {
        const now = Date.now();
        
        if (videoCache && (now - cacheTimestamp) < CACHE_TIME) {
            return videoCache;
        }
        
        try {
            const response = await axios.get(ASUPAN_JSON_URL);
            
            if (Array.isArray(response.data)) {
                videoCache = response.data.filter(url => typeof url === 'string' && url.includes('.mp4'));
                cacheTimestamp = now;
                return videoCache;
            } else {
                throw new Error('Invalid JSON format');
            }
        } catch (error) {
            console.error('Error fetching video list:', error.message);
            
            videoCache = [
                "https://b.top4top.io/m_1931yxodg0.mp4",
                "https://k.top4top.io/m_193161p380.mp4"
            ];
            cacheTimestamp = now;
            return videoCache;
        }
    }

    app.get("/random/asupan", async (req, res) => {
        try {
            const videos = await fetchVideoList();
            
            if (videos.length === 0) {
                return res.status(404).json({
                    status: false,
                    message: "Tidak ada video tersedia"
                });
            }
            
            const randomIndex = Math.floor(Math.random() * videos.length);
            const randomVideo = videos[randomIndex];
            
            try {
                const videoResponse = await axios({
                    method: 'GET',
                    url: randomVideo,
                    responseType: 'stream',
                    timeout: 10000
                });
                
                res.set({
                    'Content-Type': videoResponse.headers['content-type'] || 'video/mp4',
                    'Cache-Control': 'public, max-age=300',
                    'Access-Control-Allow-Origin': '*',
                    'X-Video-Index': randomIndex,
                    'X-Total-Videos': videos.length,
                    'X-Video-URL': randomVideo
                });
                
                videoResponse.data.pipe(res);
                
            } catch (streamError) {
                console.error('Error streaming video:', streamError.message);
                
                return res.json({
                    status: true,
                    creator: "aerixxx",
                    message: "Video asupan acak (direct URL)",
                    data: {
                        index: randomIndex,
                        video_url: randomVideo,
                        direct_url: randomVideo,
                        total_videos: videos.length,
                        note: "Streaming failed, use direct URL instead"
                    }
                });
            }
            
        } catch (error) {
            console.error('Error in /random/asupan:', error.message);
            
            return res.status(500).json({
                status: false,
                message: "Gagal mengambil video acak",
                error: error.message
            });
        }
    });
};